image: maven:3.9.6-eclipse-temurin-17

variables:
  APP_PATH: "/opt/prava-online"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

  # All secrets are stored in GitLab CI/CD Variables:
  # SSH_PRIVATE_KEY, SERVER_IP, SERVER_USER,
  # JWT_SECRET, GOOGLE_CLIENT_ID,
  # MAIL_HOST, MAIL_PORT, MAIL_USERNAME, MAIL_PASSWORD,
  # ESKIZ_EMAIL, ESKIZ_PASSWORD,
  # TELEGRAM_BOT_TOKEN, TELEGRAM_BOT_USERNAME, TELEGRAM_WEBHOOK_URL

cache:
  paths:
    - .m2/repository/

stages:
  - build
  - deploy

# ============================================
# 1. STAGE: Build Application
# ============================================
build_app:
  stage: build
  script:
    - echo "Building application..."
    - mvn clean package -DskipTests
    - echo "Build completed successfully"
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 hour
  only:
    - main

# ============================================
# 2. STAGE: Deploy to Server
# ============================================
deploy_to_server:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H ${SERVER_IP} >> ~/.ssh/known_hosts 2>/dev/null || true
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "============================================"
    - echo "DEPLOYMENT STARTED"
    - echo "============================================"

    # 1. Create necessary directories on server
    - echo "Creating directories..."
    - ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "mkdir -p $APP_PATH/target"

    # 2. Upload files to server
    - echo "Uploading files to server..."
    - scp -o StrictHostKeyChecking=no target/*.jar $SERVER_USER@$SERVER_IP:$APP_PATH/target/
    - scp -o StrictHostKeyChecking=no Dockerfile docker-compose.yml $SERVER_USER@$SERVER_IP:$APP_PATH/

    # 3. Create .env file on server with secrets from CI/CD Variables
    - echo "Creating .env file with secrets..."
    - |
      ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "cat > $APP_PATH/.env << 'ENVEOF'
      JWT_SECRET=$JWT_SECRET
      GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID
      MAIL_HOST=$MAIL_HOST
      MAIL_PORT=$MAIL_PORT
      MAIL_USERNAME=$MAIL_USERNAME
      MAIL_PASSWORD=$MAIL_PASSWORD
      ESKIZ_EMAIL=$ESKIZ_EMAIL
      ESKIZ_PASSWORD=$ESKIZ_PASSWORD
      TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN
      TELEGRAM_BOT_USERNAME=$TELEGRAM_BOT_USERNAME
      TELEGRAM_WEBHOOK_URL=$TELEGRAM_WEBHOOK_URL
      ENVEOF
      "

    # 4. Deploy with Docker Compose
    - echo "Deploying with Docker Compose..."
    - |
      ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP "
        cd $APP_PATH &&
        echo 'Stopping old containers...' &&
        docker compose down &&
        echo 'Cleaning Docker build cache...' &&
        docker builder prune -f &&
        echo 'Building new image...' &&
        docker compose build --no-cache &&
        echo 'Starting services...' &&
        docker compose up -d &&
        echo 'Waiting for application to start...' &&
        sleep 15 &&
        for i in \$(seq 1 30); do
          if docker compose exec -T app curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
            echo 'Application is healthy!'
            break
          fi
          if [ \$i -eq 30 ]; then
            echo 'Health check failed!'
            docker compose logs --tail=100 app
            exit 1
          fi
          echo \"Attempt \$i/30...\"
          sleep 5
        done &&
        echo 'Cleaning up old images...' &&
        docker image prune -f &&
        echo 'Deployment completed successfully!' &&
        echo '' &&
        echo '============================================' &&
        echo 'DEPLOYMENT STATUS' &&
        echo '============================================' &&
        docker compose ps &&
        echo '' &&
        echo 'Recent logs:' &&
        docker compose logs --tail=20 app
      "

    - echo "============================================"
    - echo "DEPLOYMENT COMPLETED SUCCESSFULLY"
    - echo "============================================"

  only:
    - main
  when: on_success

  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
